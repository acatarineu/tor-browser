<!DOCTYPE HTML>
<meta charset="UTF-8">
<html>
<head>
  <title>Test for Tor Bug #23104: CSS line-height reveals the platform Tor browser is running</title>
  <script type="application/javascript" src="/tests/SimpleTest/SimpleTest.js"></script>
  <script type="application/javascript" src="/tests/SimpleTest/SpawnTask.js"></script>
  <style type="text/css">
    .testdiv {
      background-color: #000;
      color: #fff;
      font-size: 16.5px;
    }
  </style>
</head>
<body>
  <div class="testdiv" id="test1">Test1</div>
  <div class="testdiv" id="test2">كلمة</div>
  <div class="testdiv" id="test3">ação</div>
<script>

let setPref = async function (key, value) {
  await SpecialPowers.pushPrefEnv({"set": [[key, value]]});
}

function getStyle(el, styleprop) {
  return document.defaultView.getComputedStyle(el, null).getPropertyValue(styleprop);
}

function getLineHeight(el) {
  var lineHeight = getStyle(el, 'line-height');
  if (lineHeight === "normal") {
    return el.getBoundingClientRect().height;
  }
  return parseFloat(lineHeight);
}

function validateElement(elementName, isFingerprintResistent) {
  var el = document.getElementById(elementName);
  var fontSize = getStyle(el, 'font-size');
  var validationCb = isFingerprintResistent ? is : isnot;
  var expectedLineHeight = Math.round(parseFloat(fontSize)) * 1.2;
  validationCb(getLineHeight(el).toFixed(4), expectedLineHeight.toFixed(4), 'Line Height validation');
}

add_task(async function() {
  await setPref("layout.css.line-height.normal-as-resolved-value.enabled", false);
  for (let resistFingerprintingValue of [true, false]) {
    await setPref("privacy.resistFingerprinting", resistFingerprintingValue);
    for (let elementId of ['test1', 'test2', 'test3']) {
      validateElement(elementId, resistFingerprintingValue);
    }
  }
});

</script>
</body>
</html>
